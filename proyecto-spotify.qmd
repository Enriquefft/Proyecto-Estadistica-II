---
title: "Proyecto-Spotify"
format: html
editor: visual
---

```{r}
librerias <- c("dplyr", "readr", "DBI")
for (paquete in librerias) {
  if (!require(paquete, character.only = TRUE)) {
    install.packages(paquete)
  }
	library(paquete, character.only = TRUE)
}
```

```{r}
host <- "aws-0-us-east-1.pooler.supabase.com"
db_name <- "postgres"
user <- "postgres.ssbtsqwpnmqovabbjzsc"
port <- 5432
db_password <- "giApLgnkOSm2p0yR"
con <- DBI::dbConnect(RPostgres::Postgres(), 
                      dbname = db_name, 
                      host = host, 
                      port = port, 
                      user = user, 
                      password = db_password)
```

```{r}
DF <- dbReadTable(con, "users")
DF
```

# Caso de Estudio #1

## Distribución de la media muestral de 'danceability' para los encuestados entre 15 a 25 años.

El objetivo del primer caso de estudio es evaluar la variable 'danceability' en encuestados entre las edades de 15 y 25 años. Tenemos como dato la media de la población, $\mu$, que podemos calcular usando RStudio. Luego, filtramos la base de datos para los encuestados que tienen entre 15 y 25 años. Esta será nuestra muestra, y entonces buscamos su tamaño (n) y la desviación muestral (s).

```{r}
mu = mean(DF$Danceability)
DFD <- filter(DF,"Edad" >= 15 & "Edad" <= 25)
n = sum(complete.cases(DFD))
s = sd(DFD$Danceability)
```

Entendemos para este caso que, como el tamaño de muestra es menor a 30, la media muestral se distribuye con una T-student de $n-1$ grados de libertad. Con esta información, podemos ahora resolver los siguientes incisos:

#### a. ¿Cuál es la probabilidad de que la media muestral sea mayor a 0.75?

$$
P(\overline{x}>0.75
)$$

$$
P\left(\frac{\overline{x}-\mu}{\frac{s}{\sqrt{n}}} > \frac{0.75-\mu}{\frac{s}{\sqrt{n}}}\right)
$$

$$
P(T(n-1)>a)
$$

```{r}
pt(a,n-1)
```

#### b. ¿Será posible determinar un intervalo de confianza para la media muestral? Consideremos un nivel de confianza del 95%.

```{r}
nc = 0.95
alpha = 1 - nc
t.test(DFD$Danceability, conf.level = nc)
```

# Caso de estudio 2

# Caso de estudio 3

Distribución de la diferencia de medias de la intensidad de la música escuchada por los encuestados de edad mayor a 25 años y la intensidad de la música escuchada por los encuestados de edad menor a 25 años.

```{r}
DF %>%
  filter(age <= 25) %>%
  select(average_loudness) -> df1
DF %>%
  filter(age > 25) %>%
  select(average_loudness) -> df2
```

```{r}
# Parámetros
mu1 <- mean(df1$average_loudness)
mu2 <- mean(df2$average_loudness)
s1 <- sd(df1$average_loudness)
s2 <- sd(df2$average_loudness)
n1 <- length(df1$average_loudness)
n2 <- length(df2$average_loudness)
```

¿Cual es la distribución de la diferencia de medias?

Calculamos si la varianza es igual o diferente

```{r}
var.test(df1$average_loudness, df2$average_loudness, ratio = 1, alternative = "two.sided", conf.level = 0.95)
```

Vemos que la varianza es diferente

Estamos en el caso de: no se conoce $\sigma_1$ y $\sigma\_2$ pero se sabe que son diferentes

$$ 
\begin{align*}
& T(v) = \frac{\overline{X}_1 - \overline{X}_2 - (\mu_1 - \mu_2)} {\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}} \,,\text{ siendo} \\

v &= \frac{\left(\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}\right)^2} {\frac{\left(\frac{s_1^2}{n_1}\right)^2}{n_1 - 1} + \frac{\left(\frac{s_2^2}{n_2}\right)^2}{n_2 - 1}} = \text{grados de libertad} 
\end{align*}
$$

Valores importantes

```{r}
m <- mu1 - mu2 
s <- sqrt((s1^2/n1) + (s2^2/n2)) 
v <- round(s1^2/n1 + s2^2/n2)^2/((s1^2/n1)^2/(n1-1) + (s2^2/n2)^2/(n2-1)) 

alpha <- 0.05
t <- qt(1-alpha/2,v)
```

a)  ¿Cuál es la probabilidad de que, en promedio, la intensidad de la música escuchada por los encuestados menores a 25 años supere en 10 decibeles a la intensidad de la música escuchada por los encuestados mayores a 25 años?

$$
\mathbb{P}(\overline{X}_1 - \overline{X}_2 > 10) = 1 - \mathbb{P}(\overline{X}_1 - \overline{X}_2 \leq 10) = 1 - \mathbb{P}\left(T(v) \leq \frac{10 - (\mu_1 - \mu_2)}{\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}}\right)
$$

```{r}
x <- 10
pt((x-m)/s,v, lower.tail = FALSE)
```

b)  Con 95% de confianza, ¿cuál es el intervalo de confianza para la diferencia de medias?

El intervalo de confianza se calcula con la fórmula:

$$
\mathbb{P}\left(\overline{X}_1 - \overline{X}_2 - t_{(1-\alpha/2,v)} \cdot \sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}} \leq \mu_1 - \mu_2 \leq \overline{X}_1 - \overline{X}_2 + t_{(1-\alpha/2,v)} \cdot \sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}\right) = 0.95
$$

El intervalo de confianza es:

```{r}
m + c(-1,1)*t*s
```

Otra forma de calcularlo:

```{r}
t.test(df1$average_loudness, df2$average_loudness, alternative = "two.sided", var.equal = FALSE, conf.level = 0.95)
```

¿Cómo se ve la distribución de la diferencia de medias?

```{r}
v <- 111
t <- 2
Xs <- seq(-5, 5, by = 0.001)
plot(Xs, dt(Xs,v), type = "l", col = "red")
abline(v = c(-t, t), col = "blue")
legend("topright", legend = c("T(x,v)", "t_{(1-\\alpha/2,v)}"), col = c("red", "blue"), lty = 1)
# Hacer que mayor a t_0 sea azul
lines(Xs[Xs > t], dt(Xs[Xs > t],v), col = "green")
```
