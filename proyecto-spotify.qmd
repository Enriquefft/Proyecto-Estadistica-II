---
title: "Proyecto-Spotify"
format: html
editor: visual
---

```{r}
librerias <- c("dplyr", "readr", "DBI")
for (paquete in librerias) {
  if (!require(paquete, character.only = TRUE)) {
    install.packages(paquete)
  }
	library(paquete, character.only = TRUE)
}
```

```{r}
host <- "aws-0-us-east-1.pooler.supabase.com"
db_name <- "postgres"
user <- "postgres.ssbtsqwpnmqovabbjzsc"
port <- 5432
db_password <- "giApLgnkOSm2p0yR"
con <- DBI::dbConnect(RPostgres::Postgres(), 
                      dbname = db_name, 
                      host = host, 
                      port = port, 
                      user = user, 
                      password = db_password)
```

```{r}
DF <- dbReadTable(con, "users")
DF
```

# Caso de Estudio #1

## Distribución de la media muestral de 'danceability' para los encuestados entre 15 a 25 años.

El objetivo del primer caso de estudio es evaluar la variable 'danceability' en encuestados entre las edades de 15 y 25 años. Tenemos como dato la media de la población, $\mu$, que podemos calcular usando RStudio. Luego, filtramos la base de datos para los encuestados que tienen entre 15 y 25 años. Esta será nuestra muestra, y entonces buscamos su tamaño (n) y la desviación muestral (s).

```{r}
mu = mean(DF$Danceability)
DFD <- filter(DF,"Edad" >= 15 & "Edad" <= 25)
n = sum(complete.cases(DFD))
s = sd(DFD$Danceability)
```

Entendemos para este caso que, como el tamaño de muestra es menor a 30, la media muestral se distribuye con una T-student de $n-1$ grados de libertad. Con esta información, podemos ahora resolver los siguientes incisos:

#### a. ¿Cuál es la probabilidad de que la media muestral sea mayor a 0.75?

$$
P(\overline{x}>0.75
)$$

$$
P\left(\frac{\overline{x}-\mu}{\frac{s}{\sqrt{n}}} > \frac{0.75-\mu}{\frac{s}{\sqrt{n}}}\right)
$$

$$
P(T(n-1)>a)
$$

```{r}
pt(a,n-1)
```

#### b. ¿Será posible determinar un intervalo de confianza para la media muestral? Consideremos un nivel de confianza del 95%.

```{r}
nc = 0.95
alpha = 1 - nc
t.test(DFD$Danceability, conf.level = nc)
```

# Caso de estudio 2

# Caso de esutdio 3

Analizaremos la variable danceability por edad

```{r}
DF %>%
  filter(age == 18) %>%
  select(average_danceability) -> df1
DF %>%
  filter(age == 19) %>%
  select(average_danceability) -> df2
```

```{r}
# Parámetros
mu1 <- mean(df1$average_danceability)
mu2 <- mean(df2$average_danceability)
s1 <- sd(df1$average_danceability)
s2 <- sd(df2$average_danceability)
n1 <- length(df1$average_danceability)
n2 <- length(df2$average_danceability)
```

¿Cual es la distribución de la diferencia de medias?

```{r}
m <- mu1 - mu2 
s <- sqrt((s1^2/n1) + (s2^2/n2)) 
v <- (s1^2/n1 + s2^2/n2)^2/((s1^2/n1)^2/(n1-1) + (s2^2/n2)^2/(n2-1)) 


#return(pt((x-m)/s,round(v),lower.tail = FALSE)) 
#(pt((x-m)/s,round(v))) 
```

¿Cómo se ve la distribución de la diferencia de medias?

```{r}
#plot(density(df1$average_danceability))
Xs <- seq(2, 6, by = 0.001)
plot(Xs, dif_medias(Xs,mu1,mu2,s1,s2,n1,n2), type = "l", col = "red")
```

¿Cuál es la probabilidad de que la media 1 sea menor que la media 2?

```{r}
x <- 0
pt((x-m)/s,round(v))
```

Con 95% de confianza, ¿cuál es el intervalo de confianza para la diferencia de medias?

```{r}
alpha <- 0.05
z <- qnorm(1-alpha/2)
m + c(-1,1)*z*s

```

# Parte de Arturo

## Se asume población normal

## Una muestra de menos de 30 observaciones

```{r}
df1 <-  sample_n(DF, 15)

#t.test(df1$cty, df1$hwy, alternative = "l", var.equal = FALSE, paired = FALSE, conf.level = 0.95)

# Calculando la distribución de la diferencia de medias
# mean(df1) tiene distribución t-student con n-1 grados de libertad
```

$$
\frac{\bar{x}-\mu}{\frac{s}{\sqrt{n}}} \sim T_{n-1}
$$

## Una muestra de más de 30 observaciones

```{r}
df2 <-  sample_n(DF, 50)
```
